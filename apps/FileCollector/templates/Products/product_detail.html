{% extends 'Formikaro/base_site.html' %}
{% load static %}
{% load custom_tags %}
{% block style_css %}
    <!-- default icons used in the plugin are from Bootstrap 5.x icon library (which can be enabled by loading CSS below) -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.5.0/font/bootstrap-icons.min.css" crossorigin="anonymous">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-sweetalert/1.0.1/sweetalert.css" integrity="sha512-f8gN/IhfI+0E9Fc/LKtjVq4ywfhYAVeMGKsECzDUHcFJ5teVwvKTqizm+5a84FINhfrgdvjX8hEJbem2io1iTA==" crossorigin="anonymous" />
    <!-- the fileinput plugin styling CSS file -->

    <!-- sortable.min.js is only needed if you wish to sort / rearrange files in initial preview.
        This must be loaded before fileinput.min.js -->
    <script src="https://cdn.jsdelivr.net/gh/kartik-v/bootstrap-fileinput@5.2.6/js/plugins/sortable.min.js" type="text/javascript"></script>

    <link href="https://cdn.jsdelivr.net/gh/kartik-v/bootstrap-fileinput@5.2.6/css/fileinput.min.css" media="all" rel="stylesheet" type="text/css" />
    <!-- piexif.min.js is needed for auto orienting image files OR when restoring exif data in resized images and when you
        wish to resize images before upload. This must be loaded before fileinput.min.js -->
    <script src="https://cdn.jsdelivr.net/gh/kartik-v/bootstrap-fileinput@5.2.6/js/plugins/piexif.min.js" type="text/javascript"></script>


    <!-- bootstrap.bundle.min.js below is needed if you wish to zoom and preview file content in a detail modal
        dialog. bootstrap 5.x or 4.x is supported. You can also use the bootstrap js 3.3.x versions. -->
    <!--<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.1/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>-->

    <!-- the main fileinput plugin script JS file -->
    <script src="https://cdn.jsdelivr.net/gh/kartik-v/bootstrap-fileinput@5.2.6/js/fileinput.min.js"></script>

    <!-- following theme script is needed to use the Font Awesome 5.x theme (`fas`). Uncomment if needed. -->
    <!-- script src="https://cdn.jsdelivr.net/gh/kartik-v/bootstrap-fileinput@5.2.6/themes/fas/theme.min.js"></script -->

    <!-- optionally if you need translation for your language then include the locale file as mentioned below (replace LANG.js with your language locale) -->
    <script src="https://cdn.jsdelivr.net/gh/kartik-v/bootstrap-fileinput@5.2.6/js/locales/LANG.js"></script>


    <script src="https://cdnjs.cloudflare.com/ajax/libs/TableDnD/0.9.1/jquery.tablednd.js" integrity="sha256-d3rtug+Hg1GZPB7Y/yTcRixO/wlI78+2m08tosoRn7A=" crossorigin="anonymous"></script>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <!-- Plugins css -->
    <link href="{% static 'image-uploader/image-uploader.min.css' %}" rel="stylesheet" type="text/css" />
    <style>

        .table-tight>tbody>tr>td, .mytable>tbody>tr>th, .mytable>tfoot>tr>td, .mytable>tfoot>tr>th, .mytable>thead>tr>td, .mytable>thead>tr>th {
            padding-left: 6px;
            padding-right: 6px;
        }
        .table-0p>tbody>tr>td, .mytable>tbody>tr>th, .mytable>tfoot>tr>td, .mytable>tfoot>tr>th, .mytable>thead>tr>td, .mytable>thead>tr>th {
            padding-left: 0px;
            padding-right: 0px;
        }
        .table-edits input, .table-edits select {
            height: calc(1.5em + 0.5rem + 2px);
            padding: 0.25rem 0.5rem;
            border: 1px solid #ced4da;
            color: #5b626b;
            background-color: #fff;
            border-radius: 0.25rem;
        }
        .lang-select {
            min-height: calc(0.5em + 1rem + 2px);
            font-size: 0.75rem;
            border-radius: 0.25rem;
        }
        
        .image_upload_loading {
            left: 12%;
            margin: auto;
            z-index: 999;
            display: inline-block;
            position: absolute;
            width: 2rem;
            height: 2rem;
            vertical-align: -0.125em;
            border: 0.5em solid currentColor;
            border-right-color: transparent;
            border-radius: 50%;
            -webkit-animation: 0.75s linear infinite spinner-border;
            animation: spin 1s linear infinite;
        }
          
        @keyframes spin {
            100% {
                transform: rotate(360deg);
            }
        }
        .loading_opacity {
            opacity: 0.5;
            background: #eef2f8;
        }
        .edit-control {
            display: block;
            padding: 0.875rem 1.125rem;
            width: 100%;
            font-weight: 400;
            line-height: 1;
            color: #69707a;
            background-color: #fff;
            background-clip: padding-box;
            border: 1px solid #c5ccd6;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            border-radius: 0.35rem;
            transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
        }
        .drop-thumbnail {
            display: block;
            padding: 0.25rem;
            background-color: #f2f6fc;
            border: 1px solid #d4dae3;
            border-radius: 0.35rem;
            max-width: 100%;
        }
        .upload-image-border {
            border-style: dotted !important; 
            border-width: 3px !important
        }
        .drop-image {
            border-color: blue;
        }
    </style>
{% endblock %}
{% block title %}Product Detailed View {% endblock %}
{% block content %}



<header class="page-header page-header-compact page-header-light border-bottom bg-white mb-4">
    <div class="container-fluid">
        <div class="page-header-content">
            <div class="row align-items-center justify-content-between pt-3">
                <div class="col-auto mb-3">
                    <h1 class="page-header-title">
                        <div class="page-header-icon"><i data-feather="file"></i></div>
                        Detail of product {{product.fsin}}&nbsp;{% if user.is_staff %}
                        <a target="_blank" href="{{product.get_admin_url}}"> [<strong>{{ product.fsin }}</strong>]</a>
                    {% else %}
                        [<strong>{{ product.fsin }}</strong>]
                    {% endif %}
                    </h1>
                </div>
                <div class="col-12 col-xl-auto mb-3">
                    <ul class="nav nav-pills card-header-pills" id="cardPill" role="tablist">

                        {% if product.is_active %}
                            <button class="btn btn-green me-2">ACTIVE</button>

                        {% elif not product.is_active %}
                            <button class="btn btn-red me-2">INACTIVE</button>
                        {% endif %}

                        {% if product.base.mode == 'AE' %}
                            <button class="btn btn-outline-dark me-2">After Effects</button>
                        {% elif product.base.mode == 'PR' %}
                            <button class="btn btn-outline-dark  me-2">Premiere</button>
                        {% elif product.base.mode == 'FO' %}
                            <button class="btn btn-outline-dark  me-2">FormikoBot</button>
                        {% endif %}
                        {% if product.base.needs_intake %}
                            <button class="btn btn-pink me-2">Needs Intake</button>
                        {% else %}
                            <button class="btn btn-dark me-2" onclick="window.location.href='#AssetInformation'">Needs no Intake</button>
                        {% endif %}
                        {% if product.base.assets.all %}
                            <button class="btn btn-pink me-2" onclick="window.location.href='#AssetInformation'">Needs Assets</button>
                        {% else %}
                            <button class="btn btn-dark me-2" onclick="window.location.href='#AssetInformation'">Needs no Assets</button>
                        {% endif %}


                    </ul>
                </div>
            </div>
        </div>
    </div>
</header>



<!-- Dashboard info widget 1-->
<div class="container">
    <div class="row">
        <div class="col-xl-7 col-md-12 ">
            <div class="card card-header-actions">
                <div class="card-header">

                    <ul class="nav nav-pills card-header-pills" id="cardPill" role="tablist">
                        <li class="nav-item">
                            <a class="nav-link active" id="product_preview-tab" href="#product_preview" data-toggle="tab" role="tab" aria-controls="product_preview" aria-selected="true">Preview</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" id="product_texts-tab" href="#product_texts" data-toggle="tab" role="tab" aria-controls="product_texts" aria-selected="false">Product texts</a>
                        </li>
                    </ul>
                </div>
                <div class="card-body">



                    <div class="tab-content" id="cardTabContent">
                        <div class="tab-pane fade show active" id="product_preview" role="tabpanel" aria-labelledby="product_preview-tab">
                            {% if product.vimeo_id %}
                                <div class="timeline timeline-xl text-center">
                                    <iframe src="https://player.vimeo.com/video/{{ product.vimeo_id }}" width="640" height="360" frameborder="0" allowfullscreen></iframe>
                                </div>
                            {% else %}
                                <div class="text-xs text-center ">
                                    <br><br><br><br><br>
                                    no product preview available
                                </div>
                            {% endif %}
                        </div>
                        <div class="tab-pane fade" id="product_texts" role="tabpanel" aria-labelledby="product_texts-tab">
                            <!-- Language 1-->
                            {% if product.product_texts.all %}

                                {% for line in product.product_texts.all %}
                                    <div class="table-responsive table-billing-history text-xs table-borderless mb-0 datatable">
                                        <table class="table table-hover text-xs " id="productTextTable" width="100%" cellspacing="0">

                                            <tr>
                                                <th>Title</th>
                                                <th>Description Short</th>
                                                <th>Description Long</th>
                                                <th>Language</th>
                                                {% if user.is_staff %}
                                                    <th>Actions</th>
                                                {% endif %}
                                            </tr>
                                            <tr>
                                                <td>{{line.title}}</td>
                                                <td>{{line.desc_short}}</td>
                                                <td>{{line.desc_long}}</td>
                                                <td>{{line.language.abbreviation}}</td>
                                                {% if user.is_staff %}
                                                    <td>
                                                        <button class="btn_edit_text btn btn-datatable btn-icon btn-transparent-dark mr-2" data-id="{{line.id}}" data-desc-short="{{line.desc_short}}" data-desc-long="{{line.desc_long}}" data-lang="{{line.language.id}}"  data-title="{{line.title}}"><i data-feather="edit"></i></button>
                                                        <button class="btn_delete_text btn btn-datatable btn-icon btn-transparent-dark mr-2" data-id="{{line.id}}"><i data-feather="trash-2"></i></button>
                                                    </td>
                                                {% endif %}

                                            </tr>

                                        </table></div>

                                {% endfor %}
                            {% else %}
                                <div class=" text-center justify-content-between text-xs">
                                    No product text has been defined yet
                                </div>
                            {% endif %}
                            <div class="text-center">

                                <button id="btn_add_text" class="btn btn-sm btn-primary mt-2" type="button">Add Text</button>
                            </div>

                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-5">
            <!-- TECHNICAL INFO CARD START -->
            <div class="card card-icon  mb-4 text-xs">
                <div class="row no-gutters">
                    <div class="col-auto card-icon-aside bg-secondary"><i class="text-white-50" data-feather="share-2"></i></div>
                    <div class="col">
                        <div class="card-body py-4">
                            <h3>Technical information:</h3>
                            <div class="row">
                                <div class="col-xxl-3 col-sm-12"><strong>Resolution</strong></div>
                                <div class="col-xxl-9 col-sm-12">{{ product.resolution }} ({{ product.resolution.description }})</div>
                            </div>
                            <div class="row">
                                <div class="col-xxl-3 col-sm-12"><strong>Runtime</strong></div>
                                <div class="col-xxl-9 col-sm-12">{{ product.runtime }} seconds</div>
                            </div>
                            <div class="row">
                                <div class="col-xxl-3 col-sm-12"><strong>Language</strong></div>
                                <div class="col-xxl-9 col-sm-12">{{ product.language.name }}</div>
                            </div>
                            <div class="row">
                                <div class="col-xxl-3 col-sm-12"><strong>Mode</strong></div>
                                <div class="col-xxl-9 col-sm-12">{{ product.base.get_mode_display }}</div>
                            </div>
                            <div class="row">
                                <div class="col-xxl-3 col-sm-12"><strong>Variety</strong></div>
                                <div class="col-xxl-9 col-sm-12">{% if product.variety %}{{ product.variety }}{% else %}-{% endif %}</div>
                            </div>
                            <div class="row">
                                <div class="col-xxl-3 col-sm-12"><strong>Version</strong></div>
                                <div class="col-xxl-9 col-sm-12">{{ product.version }}</div>
                            </div>
                            <div class="row">
                                <div class="col-xxl-3 col-sm-12"><strong>Vimeo ID</strong></div>
                                <div class="col-xxl-9 col-sm-12">{% if product.vimdeo_id %}{{ product.vimdeo_id }}{% else %}-{% endif %}</div>
                            </div>
                            <div class="row">
                                <div class="col-xxl-3 col-sm-12"><strong>Preview link</strong></div>
                                <div class="col-xxl-9 col-sm-12">
                                    {% autoescape off %}
                                    {{ vimeo_link }}
                                    {% endautoescape %}</div>
                            </div>

                        </div>
                    </div>
                </div>
            </div>
            <!-- TECHNICAL INFO CARD END -->

            <!-- SALES CARD START -->
            <div class="card card-icon  mb-4 text-xs">
                <div class="row no-gutters">
                    <div class="col-auto card-icon-aside bg-primary"><i class="text-white-50" data-feather="dollar-sign"></i></div>
                    <div class="col">
                        <div class="card-body py-4">
                            <h3>Sales information:</h3>
                            <div class="row">
                                <div class="col-xxl-3 col-4"><strng>Price</strong></div>
                                <div class="col-xxl-9 col-8"><strong>{{product.price}}</strong></div>
                            </div>
                            <div class="row">
                                <div class="col-xxl-3 col-4"><strong>Sold</strong></div>
                                <div class="col-xxl-9 col-8">{{product.orders_count}} times</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- SALES CARD END -->


        </div>
        <div class="row mb-5">
            <div class="col-md-12 mt-2">

                <div class="card card-header-actions">
                    
                    <div class="card-header">
                        Product Images
                    </div>
                    <div class="card-body">
                        <div class="table-billing-history text-sm mb-0">
                            <div id="sub_product_data"></div>
                            <!-- Add New Product data Part -->
                            <div class="p-2">
                                <form class="needs-validation" id="SubProductForm" novalidate>
                                    <div class="border-bottom">
                                        <div class="row mb-3">
                                            <div class="col-md-3" id="upload_part">
                                                <div id="image_empty" class="mx-auto p-5 text-lg text-muted border upload-image-border rounded text-center">Uploaded Images
                                                </div>
                
                                                <div class="text-primary d-flex justify-content-center align-items-center" id="upload_area">
                                                    <div id="image_loading" class="text-primary"></div>
                                                    <div id="preview"></div>
                                                </div>
                                            </div>
                                            <div class="col-md-8">
                                                <div id="lang_description">
                                                    {% for lang in langs %}
                                                    <div class="row">
                                                        <div class="col-md-6">
                                                            <div class="mb-2">
                                                                <input class="form-control form-control-sm" type="text" placeholder="Image Title ({{lang.name}})">
                                                            </div>
                                                        </div>
                                                        <div class="col-md-6">
                                                            <div class="mb-2">
                                                                <input class="form-control form-control-sm" type="text" placeholder="Image Description ({{lang.name}})">
                                                            </div>
                                                        </div>
                                                    </div>
                                                    {% endfor %}
                                                </div>
                                                <div id="lang_description_list">
                                                </div>
                                                
                                            </div>
                                            
                                            <div class="col-md-1">
                                                <div class="m-2 justify-content-end d-flex">
                                                    <button class="btn btn-primary btn-sm btn_product_info_save" style="display: none;" type="button">Save</button>
                                                </div>
                                            </div>
                                            <div class="col-md-1"></div>
                                            <input type="hidden" value="-1" id="uploaded_id" />
                                        </div>            
                                    </div>
                                </form>
                                <!-- DROP ZONE -->
                                <div class="row" ondrop="dropHandler(event);" ondragover="dragOverHandler(event);" ondragleave="dragLeaveHandler(event)">
                                    <label id="drop_zone" class="mx-auto p-5 text-lg rounded text-center" style="border-style: dotted !important; border-width: 3px !important">
                                        <input type="file" id='files' style="display: none;" name="files[]" multiple>Drop here
                                    </label>
                                    
                                </div>
                    
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>


        <!--
        <div class="col-xl ">
            <div class="row"  >
                <div class="col mb-1" >
                    <div class="card bg-primary border-0 h-100 ">
                        <div class="card-body ">
                            <h5 class="text-white-50">Operational</h5>
                            <div class="mb-4">
                                <span class="display-4 text-white">{{product.orders_count}} times ordered</span>
                                <span class="text-white-50">
                                            <br/>({{product.failed_products_count}} error(s))</span>
                            </div>

                        </div>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col">
                    <div class="card bg-secondary border-0 h-100 " >
                        <div class="card-body ">
                            <h5 class="text-white-50">Scope</h5>
                            <div class="mb-4">
                                <span class="display-4 text-white">{{product.runtime | seconds_to_clock}}</span>
                                <span class="text-white-50"><br />(run time)</span>
                            </div>

                        </div>
                    </div>

                </div>
            </div>
        </div>-->

        <div class="row">
            <div class="col-12 mt-2">
                <div class="card card-icon mb-4" id="AssetInformation">
                    <div class="row no-gutters text-xs">
                        <div class="col-auto card-icon-aside bg-info"><i class="text-white-50" data-feather="file-plus"></i></div>
                        <div class="col">

                            <div class="card-body py-4" >
                                <h3>Asset information:</h3>
                                {% if product.base.assets.all %}
                                    <span class="text-xs gray">These assets are needed for the production of this product:</span>

                                    <br><br>
                                    {% for asset in product.base.assets.all %}
                                        <div class="row">
                                            <div class="col-3"><strong>{{asset.name}}</strong></div>
                                            <div class="col-2">{{asset.value}}</div>
                                            <div class="col-2">{{asset.type}}</div>
                                            <div class="col-2">
                                                {% if asset.assettype.is_file %}
                                                    <span data-feather="file">file</span>
                                                {% else %}
                                                    <span></span>
                                                {% endif %}

                                            </div>
                                            <div class="col-2">{{asset.owner}}</div>
                                        </div>
                                    {% endfor %}
                                {% else %}
                                    There are no assets defined that are needed for the production of this product
                                {% endif %}

                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col">
                <div class="card mb-4 ">
                    <div class="card-header">List of other products with the same product base</div>
                    <div class="card-body">
                        {% if related_products %}
                            <div class="datatable">
                                <table class="table table-bordered table-hover" id="dataTableDEACTIVATED" width="100%" cellspacing="0">
                                    <thead>
                                    <tr>
                                        <th>FSIN</th>
                                        <th>Product name</th>
                                        <th>Runtime</th>
                                        <th>Status</th>
                                        <th>Created at</th>
                                    </tr>
                                    </thead>
                                    <tbody>
                                    {% for line in related_products %}
                                        <tr>
                                            <td><a href="{% url 'FileCollector:product_detail' line.id %}">{{line.fsin }}</a></td>
                                            <td>{{line.base.name}}</td>
                                            <td>{{line.runtime}}</td>


                                            <td>
                                                {% if line.is_active %}
                                                    <div class="badge  badge-success">ACTIVE</div>
                                                {% else %}
                                                    <div class="badge  badge-warning">NOT ACTIVE</div>
                                                {% endif %}

                                            </td>

                                            <td>{{line.created}}</td>
                                        </tr>
                                    {% endfor %}
                                    </tbody>
                                </table>
                                <hr>
                                -
                            </div>
                        {% else %}
                            <div class="text-xs text-center ">There are no other products on this ProductBase</div>
                        {% endif %}
                    </div>
                </div>

            </div>
            <!-- End page content -->
            <!-- Modal -->
            <div class="modal fade" id="editTextInfo" tabindex="-1" role="dialog" aria-labelledby="editTextInfoCenterTitle" aria-hidden="true">
                <div class="modal-dialog modal-dialog-centered" role="document">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="editTextInfoCenterTitle">Add Text Information</h5>
                            <button class="close" type="button" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">×</span></button>
                        </div>
                        <div class="modal-body">
                            <div class="form-group">
                                <label for="language">Language</label>
                                <select class="form-control" id="language">
                                    {% for lang in langs %}
                                        <option value="{{lang.id}}">{{lang.name}}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="title">TITLE</label>
                                <input class="form-control" id="title" type="text" placeholder="">
                            </div>
                            <div class="form-group">
                                <label for="description_short">SHORT DESCRIPTION</label>
                                <input class="form-control" id="description_short" type="text" placeholder="">
                            </div>
                            <div class="form-group">
                                <label for="description_long">LONG DESCRIPTION</label>
                                <textarea class="form-control" id="description_long" rows="3"></textarea>
                            </div>
                            <input type="hidden" id="prod_text_id" value="-1" />
                            <input type="hidden" id="prod_id" value="{{ product.id }}" />
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-secondary" type="button" data-dismiss="modal">Close</button>
                            <button id="btn_save_text" class="btn btn-primary" type="button">Save</button>
                        </div>
                    </div>
                </div>

                {% endblock %}
                {% block javascript %}
                    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-sweetalert/1.0.1/sweetalert.min.js"></script>
                    <!-- Plugins js -->
                    <!-- <script src="{% static 'image-uploader/image-uploader.min.js' %}"></script> -->
                    <script>
                        // $('#picture_dropzone').imageUploader();
                        var image_counter = 0;
                        var loading = false;
                        function readFile(input) {
                            var form_data = new FormData();
                            var totalfiles = document.getElementById('files').files.length;
                            
                            if (totalfiles > 5 || image_counter + totalfiles > 5) {
                                alert("Oops, More 5 images can not import!")
                            } else {
                                $("#files").prop('disabled', true);
                                
                                loading = true;
                                $("#image_empty").hide();
                                $("#preview").show();
                                $("#upload_area").addClass('upload-image-border');
                                $("#image_loading").addClass('image_upload_loading text-teal');
                                $("#upload_part").addClass("loading_opacity");
                                $("#drop_zone").addClass('drop-image');
                                form_data.append('productid', `{{product.id}}`);
                                var k = 0;
                                for(var inputfile of input.files) {
                                    if (inputfile) {
                                        k++;
                                        var reader = new FileReader();
                                        reader.onload = function (e) {
                                            $('#preview').append('<img class="drop-thumbnail upload-image-border m-1" src="'+e.target.result+'" width="80px;" height="80px">');
                                        };
                                        reader.readAsDataURL(inputfile);
                                        form_data.append('image_files', inputfile);
                                        $("#lang_description").hide();
                                        var des_id = parseInt(image_counter) + k;
                                        $('#lang_description_list').append(
                                            '<div class="mt-2 mb-1" id="' + des_id + '">' + 
                                                {% for lang in langs %}
                                                '<div class="row">' +
                                                    '<div class="col-md-6">' +
                                                        '<div class="mb-2">' +
                                                            '<input class="form-control form-control-sm" id="upload_picture_title_{{lang.abbreviation}}_' + des_id + '" type="text" data-lang="{{lang.id}}"  placeholder="Image Title ({{lang.name}})" required>' +
                                                        '</div>' +
                                                    '</div>' +
                                                    '<div class="col-md-6">' +
                                                        '<div class="mb-2">' +
                                                            '<input class="form-control form-control-sm" id="upload_picture_description_{{lang.abbreviation}}_' + des_id + '" type="text" data-lang="{{lang.id}}" placeholder="Image Description ({{lang.name}})" required>' +
                                                        '</div>' +
                                                    '</div>' +
                                                '</div>' +
                                                {% endfor %}
                                            '</div>'
                                        );
                                        
                                    }
                                }
                                image_counter = image_counter + totalfiles;
                                $(".btn_product_info_save").hide();
                                $.ajax({
                                    headers:{ 'X-CSRFToken': "{{csrf_token}}" },
                                    url: "{% url 'FileCollector:product_image_data_add' %}",
                                    type: 'POST',
                                    data: form_data,
                                    cache: false,
                                    contentType: false,
                                    processData: false,  
                                    success: function (data) {
                                        if(data.status == "success") {
                                            $("#image_loading").removeClass('image_upload_loading text-teal');
                                            $("#upload_part").removeClass('loading_opacity');
                                            $("#drop_zone").removeClass('drop-image');
                                            //ajax_all_sub_product();
                                            if ($("#uploaded_id").val() == "-1") {
                                                $("#uploaded_id").val(data.uploaded.join());
                                            } else {
                                                $("#uploaded_id").val($("#uploaded_id").val() + "," + data.uploaded.join());
                                            }
                                            $("#files").prop('disabled', false);
                                            $(".btn_product_info_save").show();
                                            loading = false;
                                            
                                        }
                                    }
                                });
                            }
                        }
                        $('#files').on('change', function () {
                            readFile(this);
                            
                        });

                        function dragOverHandler(ev) {
                            // Prevent default behavior (Prevent file from being opened)
                            $('#drop_zone').css("background-color", "#d4dae3");
                            ev.preventDefault();
                        }
                        function dragLeaveHandler(e){
                            e.preventDefault();
                            $('#drop_zone').css("background-color", "#ffffff");
                        }
                        function dropHandler(ev) {
                            // Prevent default behavior (Prevent file from being opened)
                            ev.preventDefault();
                            if(loading == true) {
                                alert("Oops, Now Image Uploading, Please Wait!")
                            } else {
                                if (ev.dataTransfer.items) {
                                    if (image_counter + ev.dataTransfer.items.length > 5) {
                                        alert("Oops, More 5 images can not import!")
                                    } else {
                                        $('#drop_zone').css("background-color", "#ffffff");
                                        $("#files").prop('disabled', true);
                                        $("#drop_zone").addClass('drop-image');
                                        
                                        var form_data = new FormData();
                                        loading = true;
                                        // Use DataTransferItemList interface to access the file(s)
                                        for (var i = 0; i < ev.dataTransfer.items.length; i++) {
                                        // If dropped items aren't files, reject them
                                            if (ev.dataTransfer.items[i].kind === 'file') {
                                                var file = ev.dataTransfer.items[i].getAsFile();
                                                $("#image_empty").hide();
                                                $("#preview").show();
                                                $("#upload_area").addClass('upload-image-border');
                                                $("#image_loading").addClass('image_upload_loading text-teal');
                                                $("#upload_part").addClass("loading_opacity");
                                                form_data.append('productid', `{{product.id}}`);
                                                var reader = new FileReader();
                                                reader.onload = function (e) {
                                                    $('#preview').append('<img class="drop-thumbnail m-1" src="'+e.target.result+'" width="80px;" height="80px">');
                                                };
                                                reader.readAsDataURL(file);
                                                form_data.append('image_files', file);
                                                $("#lang_description").hide();
                                                var des_id = parseInt(image_counter) + i + 1;
                                                $('#lang_description_list').append(
                                                    '<div class="mt-2 mb-1" id="' + des_id + '">' + 
                                                        {% for lang in langs %}
                                                        '<div class="row">' +
                                                            '<div class="col-md-6">' +
                                                                '<div class="mb-2">' +
                                                                    '<input class="form-control form-control-sm" id="upload_picture_title_{{lang.abbreviation}}_' + des_id + '" type="text" data-lang="{{lang.id}}"  placeholder="Image Title ({{lang.name}})" required>' +
                                                                '</div>' +
                                                            '</div>' +
                                                            '<div class="col-md-6">' +
                                                                '<div class="mb-2">' +
                                                                    '<input class="form-control form-control-sm" id="upload_picture_description_{{lang.abbreviation}}_' + des_id + '" type="text" data-lang="{{lang.id}}" placeholder="Image Description ({{lang.name}})" required>' +
                                                                '</div>' +
                                                            '</div>' +
                                                        '</div>' +
                                                        {% endfor %}
                                                    '</div>'
                                                );
                                            }
                                        }
                                        image_counter = image_counter + ev.dataTransfer.items.length;
                                        $(".btn_product_info_save").hide();
                                        $.ajax({
                                            headers:{ 'X-CSRFToken': "{{csrf_token}}" },
                                            url: "{% url 'FileCollector:product_image_data_add' %}",
                                            type: 'POST',
                                            data: form_data,
                                            cache: false,
                                            contentType: false,
                                            processData: false,  
                                            success: function (data) {
                                                if(data.status == "success") {
                                                    $("#image_loading").removeClass('image_upload_loading text-teal');
                                                    $("#upload_part").removeClass('loading_opacity');
                                                    $("#drop_zone").removeClass('drop-image');
                                                    //ajax_all_sub_product();
                                                    if ($("#uploaded_id").val() == "-1") {
                                                        $("#uploaded_id").val(data.uploaded.join());
                                                    } else {
                                                        $("#uploaded_id").val($("#uploaded_id").val() + "," + data.uploaded.join());
                                                    }
                                                    $("#files").prop('disabled', false);
                                                    $(".btn_product_info_save").show();
                                                    loading = false;
                                                    
                                                }
                                            }
                                        });
                                    }
                                    
                                } else {
                                    // Use DataTransfer interface to access the file(s)
                                    for (var i = 0; i < ev.dataTransfer.files.length; i++) {
                                        console.log('... file[' + i + '].name = ' + ev.dataTransfer.files[i].name);
                                    }
                                }
                            }
                            
                        }
                        $(".btn_product_info_save").on('click', function(e){
                            if($("#uploaded_id").val() == "-1") {
                                alert("There is no uploaded Product Image!")
                            } else {
                                var form = $("#SubProductForm");
                                if (form[0].checkValidity() === false) {
                                    event.preventDefault();
                                    event.stopPropagation();
                                    form.addClass('was-validated');
                                    return;
                                }
                                var form_data = new FormData();                      
                                form_data.append('uploaded_ids', $("#uploaded_id").val());
                                var upids = $("#uploaded_id").val().split(",");
                                for (var i=1; i<= parseInt(image_counter);i++) {
                                    {% for lang in langs %}
                                        form_data.append('upload_picture_title_{{lang.abbreviation}}_' + i, $("#upload_picture_title_"+`{{lang.abbreviation}}` + '_' + i).val());
                                        form_data.append('upload_picture_description_{{lang.abbreviation}}_' + i, $("#upload_picture_description_"+`{{lang.abbreviation}}`+ '_' + i).val());
                                    {% endfor %}

                                }
                                
                                $.ajax({
                                    headers:{ 'X-CSRFToken': "{{csrf_token}}" },
                                    url: "{% url 'FileCollector:product_image_text_add' %}",
                                    type: 'POST',
                                    data: form_data,
                                    cache: false,
                                    contentType: false,
                                    processData: false,  
                                    success: function (data) {
                                        if(data.status == "success") {
                                            $("#lang_description_list").html('');
                                            $("#lang_description").show();
                                            $("#uploaded_id").val('-1');
                                            $("#preview").html("");
                                            $("#preview").hide();
                                            $("#upload_area").removeClass('upload-image-border');
                                            $("#image_empty").show();
                                            ajax_all_sub_product();
                                            $(".btn_product_info_save").hide();
                                            image_counter = 0;
                                            
                                        }
                                    }
                                });
                            }
                            
                            
                        });
                        $(document).on('click', '.btn_edit_info', function(e) {
                            $(this).closest('tr').find('.btn_save_info').show();
                            $(this).closest('tr').find('.btn_delete_info').hide();
                            $(this).closest('tr').find('.btn_init_info').show();
                            $(this).hide();
                            var currentTD = $(this).closest('tr').find('td');
                            //enable the current row
                            $.each(currentTD, function() {
                                $(this).find('.p_title').prop('contenteditable', true);
                                $(this).find('.p_desc').prop('contenteditable', true);
                                $(this).find('.p_title').addClass('edit-control');
                                $(this).find('.p_desc').addClass('edit-control');
                            });

                        });
                        $(document).on('click', '.btn_init_info', function(e) {
                            $(this).closest('tr').find('.btn_save_info').hide();
                            $(this).closest('tr').find('.btn_delete_info').show();
                            $(this).closest('tr').find('.btn_edit_info').show();
                            $(this).hide();
                            var currentTD = $(this).closest('tr').find('td');
                            //enable the current row
                            $.each(currentTD, function() {
                                $(this).find('.p_title').prop('contenteditable', false);
                                $(this).find('.p_desc').prop('contenteditable', false);
                                $(this).find('.p_title').removeClass('edit-control');
                                $(this).find('.p_desc').removeClass('edit-control');
                            });

                        });
                        $(document).on('click', '.btn_save_info', function(e) {
                            $(this).closest('tr').find('.btn_save_info').hide();
                            $(this).closest('tr').find('.btn_delete_info').show();
                            $(this).closest('tr').find('.btn_edit_info').show();
                            $(this).closest('tr').find('.btn_init_info').hide();

                            var currentTD = $(this).closest('tr').find('td');
                            $.each(currentTD, function() {
                                $(this).find('.p_title').prop('contenteditable', true);
                                $(this).find('.p_desc').prop('contenteditable', true);
                                $(this).find('.p_title').removeClass('edit-control');
                                $(this).find('.p_desc').removeClass('edit-control');
                            });
                            $.ajax({
                                headers: { "X-CSRFToken": '{{csrf_token}}' },
                                url: '{% url "FileCollector:ajax_product_image_sub_update" %}',
                                data: {
                                    imagetextid: $(this).data('imagetextid'),
                                    title: currentTD.find('.p_title').text(),
                                    description: currentTD.find('.p_desc').text()
                                },
                                type: 'POST',
                                success: function (data) {
                                    if(data.status == "success") {
                                        //ajax_all_sub_product();
                                    }
                                }
                            });
                        });
                        
                        $(document).on('click', '.btn_delete_info', function(e) {
                            var imagetextid = $(this).data('imagetextid');
                            var currentTD = $(this).closest('tr');
                    
                            swal({
                                    title: "Do you want to delete the text entry for " + $(this).data('language') +"?",
                                    text: "You will not be able to recover this Image Text Information!",
                                    type: "warning",
                                    showCancelButton: true,
                                    confirmButtonClass: "btn-danger",
                                    confirmButtonText: "Yes, delete it!",
                                    cancelButtonText: "No, cancel plx!",
                                },
                                function(isConfirm) {
                                    if (isConfirm) {
                                        $.ajax({
                                            headers: { "X-CSRFToken": '{{csrf_token}}' },
                                            url: '{% url "FileCollector:ajax_product_image_sub_delete" %}',
                                            data: {
                                                imagetextid: imagetextid,
                                            },
                                            type: 'POST',
                                            success: function (data) {
                                                if(data.status == "success") {
                                                    currentTD.find('.p_title').text('');
                                                    currentTD.find('.p_desc').text('')
                                                    //ajax_all_sub_product();
                                                }
                                            }
                                        });
                                    }
                                }
                            );
                            
                        });
                        $("#btn_add_text").on('click', function(){
                            $("#editTextInfoCenterTitle").html("Add Text Information");
                            $("#prod_text_id").val("-1");
                            $("#editTextInfo").modal('show');
                        });
                        $(".btn_edit_text").on('click', function(){
                            $("#editTextInfoCenterTitle").html("Edit Text Information");
                            $("#prod_text_id").val($(this).data('id'));
                            $("#title").val($(this).data('title'));
                            $("#language").val($(this).data('lang'));
                            $("#description_short").val($(this).data('desc-short'));
                            $("#description_long").val($(this).data('desc-long'));
                            $("#editTextInfo").modal('show');
                        });
                        $("#btn_save_text").on('click', function(){
                            $.ajax({
                                headers: { "X-CSRFToken": '{{csrf_token}}' },
                                url: "{% url 'FileCollector:save_product_text_info' %}",
                                data: {
                                    "prod_id": $("#prod_id").val(),
                                    "prod_text_id": $("#prod_text_id").val(),
                                    "title": $("#title").val(),
                                    "description_short": $("#description_short").val(),
                                    "description_long": $("#description_long").val(),
                                    "language": $("#language").val(),
                                },
                                type: 'POST',
                                success: function (data) {
                                    $("#editTextInfo").modal('hide');
                                    $("#div_text_info").html(data);
                                    $("#title").val("");
                                    $("#description_short").val("");
                                    $("#description_long").val("");
                                }
                            });
                        });
                        $(".btn_delete_text").on('click', function(){
                            var prod_text_id = $(this).data('id');
                            swal({
                                    title: "Are you sure?",
                                    text: "You will not be able to recover this Text Information!",
                                    type: "warning",
                                    showCancelButton: true,
                                    confirmButtonClass: "btn-danger",
                                    confirmButtonText: "Yes, delete it!",
                                    cancelButtonText: "No, cancel plx!",
                                },
                                function(isConfirm) {
                                    if (isConfirm) {
                                        $.ajax({
                                            headers: { "X-CSRFToken": '{{csrf_token}}' },
                                            url: "{% url 'FileCollector:delete_product_text_info' %}",
                                            data: {
                                                "prod_text_id": prod_text_id,
                                                "prod_id": $("#prod_id").val(),
                                            },
                                            type: 'POST',
                                            success: function (data) {
                                                $("#div_text_info").html(data);
                                            }
                                        });
                                    }
                                }
                            );

                        });
                        $(document).on("click",".delete_product_image", function(e){
                            var prod_image_id = $(this).data('id');
                            swal({
                                    title: "Are you sure?",
                                    text: "You will not be able to recover this Image Information!",
                                    type: "warning",
                                    showCancelButton: true,
                                    confirmButtonClass: "btn-danger",
                                    confirmButtonText: "Yes, delete it!",
                                    cancelButtonText: "No, cancel plx!",
                                },
                                function(isConfirm) {
                                    if (isConfirm) {
                                        $.ajax({
                                            headers: { "X-CSRFToken": '{{csrf_token}}' },
                                            url: "{% url 'FileCollector:delete_product_image_info' %}",
                                            data: {
                                                "prod_image_id": prod_image_id,
                                            },
                                            type: 'POST',
                                            success: function (data) {
                                                if(data="ok") {
                                                    ajax_all_sub_product();
                                                }
                                            }
                                        });
                                    }
                                }
                            );

                        });
                        ajax_all_sub_product();
                        function ajax_all_sub_product() {
                            $.ajax({
                                headers: { "X-CSRFToken": '{{csrf_token}}' },
                                url: '{% url "FileCollector:ajax_all_sub_product" %}',
                                data: {
                                    productid: `{{product.id}}`
                                },
                                type: 'POST',
                                success: function (data) {
                                    $("#sub_product_data").html(data);
                                }
                            });
                        };
                    </script>
                {% endblock %}
           